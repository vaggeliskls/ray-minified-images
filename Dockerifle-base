
ARG PYTHON_VERSION=3.10
FROM debian:bullseye-slim

LABEL org.opencontainers.image.authors="vaggeliskls"
LABEL org.opencontainers.image.description="A minified version of ray images"

# set environment variables
ENV PYTHONDONTWRITEBYTECODE="1"
ENV PYTHONUNBUFFERED="1"

# install packages
RUN apt-get update && apt-get install -y \
    wget \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Detect the architecture and download the appropriate Miniconda installer
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
    MINICONDA_URL=https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh; \
    elif [ "$ARCH" = "aarch64" ]; then \
    MINICONDA_URL=https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-aarch64.sh; \
    else \
    echo "Unsupported architecture: $ARCH"; exit 1; \
    fi && \
    wget --quiet $MINICONDA_URL -O /tmp/miniconda.sh && \
    /bin/bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

# Add conda to PATH
ENV PATH="/opt/conda/bin:$PATH"

# Create conda environment and install Python
RUN conda create -n ray python=$PYTHON_VERSION -y && \
    conda activate ray

RUN conda config --add channels conda-forge && \
    conda config --set channel_priority strict && \
    conda create -n ray python=$PYTHON_VERSION && \
    conda activate ray

# ENV PATH="/opt/conda/envs/ray/bin:$PATH"

# Update pip and setuptools
RUN pip install --upgrade pip setuptools